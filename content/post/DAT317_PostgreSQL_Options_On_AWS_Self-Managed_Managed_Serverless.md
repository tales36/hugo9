---
title: "DAT317_PostgreSQL_Options_On_AWS_Self Managed_Managed_Serverless"
date: 2019-12-03T12:17:31+09:00
author: "katsutoshi miyata"
tags: ["勉強系"]
tags: ["AWS re:invent2019"]
---

## ■概要
### ■なんでPostgreSQL？
・オープンソースで30年以上コミュニティがある唯一の企業。  
・パフォーマンスとスケーリングがヤバい。  
・大規模なテーブルは多くの場合でクエリが遅くなる原因になるが、その中でもPostgreSQLは安定した挙動をする。

### ■PostgreSQLをAWSで使う場合。
・EC2上でセルフマネージドにするか、RDSでマネージドにするかの二択。  
・マネージドにした場合のメリット  
　→バージョン9.6、10、11と60以上のバージョンが使える  
　→バックアップとリカバリーも付いてくる  
　→HA構成もお手の物  
　→セキュリティだってAWS管理だから安心

## ■RDSについて
### ■バージョンについて
PostgreSQL 9.4～9.6、10と11が対応。
### **12がプレビュー版で出る(予定)。**

### ■Aurora PostgreSQL
普通のPostgreSQLより大体2~3倍速い。
対応は9.6以降のPostgreSQL。
HAだと、**ディスクは6台構成のストレージ**になっている。

### ■Aurora Serverless
対応は10.7のみ  
スケールアップもダウンも自動でやってくれる。  
高可用性を持ち、そして障害時も自動フェイルオーバー。  

## ■RDSのオプションについて

### ■RDS PostgreSQL HA構成
Multi-AZを使いましょう

### ■RDS PostgreSQL Backups
一日一回のバックアップと5分毎のトランザクションバックアップ。

### ■セキュリティについて
・SSL暗号化が使える。RDSインスタンスで。  
・コントロールパネルから更新時期も含めて確認可能。  

### ■認証について
IAM+Kerberos Authenticationというのを使ってADのユーザーでPostgreSQLの認証が出来る。

### ■オブジェクトのセキュリティ
直接ユーザーをセレクトするのではなく、ad_userというユーザーを作成する。  
　→ad_userとすると上記のKerberos経由でADからユーザー情報を取ってくる？  
 　→ちょっと長めのファンクションコードを書いてる...。

### ■AWS Secrets Manager
パスワードポリシーをつけることができる。  
ライフサイクルやセーフティなどを。RDSとAurora PostgreSQLで使える。  
やるならマルチメソッドでやった方がいい。

## ■モニタリングについて
### ■Cloud watch  
ロードタイムや、ソートしたトップのSQL、ホストやユーザーや止まってるイベントも。  
データは2年間メトリクスが残る。  

### ■Amazon Cloudwatch Logs
PostgreSQL LogsリアルタイムでCloud watchにPushされる。  
長い事ロックされてるやつや、Connection failedも一目で分かる。

## ■アップグレード
### ■マイナーバージョンアップ
マイナーバージョンのアップグレードは自動でやってくれる。  
　→大体５～１０分ダウンタイムが出来る。

### ■メジャーバージョンアップ
　→複数のメジャーバージョンアップを途中のメジャーバージョン無視してできるように　new  
　→メジャーバージョンはオブジェクトの数やデータベースサイズによって時間が必要。

## ■building postgreSQL application
### ■Application requirements  
S3にJson形式のデータを置く。それをLambdaが取る。それをRDSに送るという作り。

### ■Amazon S3Import
Amazon S3がPostgreSQLのテーブルを直接取り込めるサービス

### ■セキュリティについて
IAMと認証キーを作成すること

### ■パーティションテーブルを作ってみよう
大規模なテーブルに小さなテーブルで区切ってみる。  
出来たデータをjson形式で返そう

### ■最後のまとめ
HAならMulti-AZ使ってね。  
自動バックアップは7日ローテーションだよ。  
SSLコネクションつかってね。  
パスワードは強度の高いのをローテーションしてね。  
テーブルが大きいときのメジャーバージョンアップは気を付けてね。

## ■感想
割と知ってることばかりで、Serverlessについてあまり触れられてなくて残念。
S3Importは面白そうなので一回試してみたい。